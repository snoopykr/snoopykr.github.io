---
layout: single
title: "로컬에서 작동하는 LLM"
categories : LLM
tag: [ollama, llama3, llama.cpp, huggingfase]
---

로컬에서 LLM을 사용하기

### 환경 구성

개발 환경 : Retina 5K, 27-inch, 2019 iMac

PyCharm 2024.1.4 (Professional Edition)

Poetry 설치 : https://snoopykr.github.io/python/poetry/

Ollama 설치 : https://ollama.com/download

llama.cpp 설치 : https://snoopykr.github.io/ai/gguf/

Postman 설치 : https://www.postman.com/downloads/

소스 : https://github.com/snoopykr/HuggingfaceHub

### 전처리 및 Dirctory 구조

HuggingfaceHub 가상 환경 구성후 llama.cpp를 내부에 clone.

poetry package 설치

```bash
(huggingfacehub-py3.11) snoopy_kr@iMac HuggingfaceHub % poetry install
```

Directory 구조

```bash
(huggingfacehub-py3.11) snoopy_kr@iMac HuggingfaceHub %  ls -al
total 31417576
drwxr-xr-x   15 snoopy_kr  staff          480 Jul 19 17:10 .
drwxr-xr-x   12 snoopy_kr  staff          384 Jul 19 13:53 ..
-rw-r--r--@   1 snoopy_kr  staff         6148 Jul 19 14:48 .DS_Store
drwxr-xr-x   12 snoopy_kr  staff          384 Jul 19 17:16 .git
-rw-r--r--    1 snoopy_kr  staff          583 Jul 19 17:10 .gitignore
drwxr-xr-x    9 snoopy_kr  staff          288 Jul 19 17:15 .idea
-rw-r--r--@   1 snoopy_kr  staff          597 Jul 19 14:51 Modelfile
-rw-r--r--    1 snoopy_kr  staff          235 Jul 19 13:55 download.py
drwxr-xr-x  143 snoopy_kr  staff         4576 Jul 19 17:07 llama.cpp
-rw-r--r--    1 snoopy_kr  staff       125506 Jul 19 14:42 poetry.lock
-rw-r--r--    1 snoopy_kr  staff          907 Jul 19 14:42 pyproject.toml
```

### Downloading a HuggingFace model

download.py

```python
from huggingface_hub import snapshot_download
model_id="MLP-KTLim/llama-3-Korean-Bllossom-8B"
snapshot_download(repo_id=model_id, local_dir="llama-3-Korean-Bllossom-8B",
                  local_dir_use_symlinks=False, revision="main")
```

실행

```bash
(huggingfacehub-py3.11) snoopy_kr@iMac HuggingfaceHub %  python download.py
```

llama-3-Korean-Bllossom-8B 디렉토리 생성 확인

```bash
(huggingfacehub-py3.11) snoopy_kr@iMac HuggingfaceHub %  ls -al
total 31417576
drwxr-xr-x   15 snoopy_kr  staff          480 Jul 19 17:10 .
drwxr-xr-x   12 snoopy_kr  staff          384 Jul 19 13:53 ..
-rw-r--r--@   1 snoopy_kr  staff         6148 Jul 19 14:48 .DS_Store
drwxr-xr-x   12 snoopy_kr  staff          384 Jul 19 17:16 .git
-rw-r--r--    1 snoopy_kr  staff          583 Jul 19 17:10 .gitignore
drwxr-xr-x    9 snoopy_kr  staff          288 Jul 19 17:15 .idea
-rw-r--r--@   1 snoopy_kr  staff          597 Jul 19 14:51 Modelfile
-rw-r--r--    1 snoopy_kr  staff          235 Jul 19 13:55 download.py
drwxr-xr-x   15 snoopy_kr  staff          480 Jul 19 13:59 llama-3-Korean-Bllossom-8B
drwxr-xr-x  143 snoopy_kr  staff         4576 Jul 19 17:07 llama.cpp
-rw-r--r--    1 snoopy_kr  staff       125506 Jul 19 14:42 poetry.lock
-rw-r--r--    1 snoopy_kr  staff          907 Jul 19 14:42 pyproject.toml
```

### Converting the model

실행

```bash
(huggingfacehub-py3.11) snoopy_kr@iMac HuggingfaceHub % cd llama.cpp 

(huggingfacehub-py3.11) snoopy_kr@iMac llama.cpp % python convert-hf-to-gguf.py ../llama-3-Korean-Bllossom-8B --outfile ..llama-3-Korean-Bllossom-8B.gguf
```

llama-3-Korean-Bllossom-8B.gguf 파일 생성 확인

```bash
(huggingfacehub-py3.11) snoopy_kr@iMac HuggingfaceHub %  ls -al
total 31417576
drwxr-xr-x   15 snoopy_kr  staff          480 Jul 19 17:10 .
drwxr-xr-x   12 snoopy_kr  staff          384 Jul 19 13:53 ..
-rw-r--r--@   1 snoopy_kr  staff         6148 Jul 19 14:48 .DS_Store
drwxr-xr-x   12 snoopy_kr  staff          384 Jul 19 17:16 .git
-rw-r--r--    1 snoopy_kr  staff          583 Jul 19 17:10 .gitignore
drwxr-xr-x    9 snoopy_kr  staff          288 Jul 19 17:15 .idea
-rw-r--r--@   1 snoopy_kr  staff          597 Jul 19 14:51 Modelfile
-rw-r--r--    1 snoopy_kr  staff          235 Jul 19 13:55 download.py
drwxr-xr-x   15 snoopy_kr  staff          480 Jul 19 13:59 llama-3-Korean-Bllossom-8B
-rw-r--r--    1 snoopy_kr  staff  16068891008 Jul 19 14:49 llama-3-Korean-Bllossom-8B.gguf
drwxr-xr-x  143 snoopy_kr  staff         4576 Jul 19 17:07 llama.cpp
-rw-r--r--    1 snoopy_kr  staff       125506 Jul 19 14:42 poetry.lock
-rw-r--r--    1 snoopy_kr  staff          907 Jul 19 14:42 pyproject.toml
```

### Add Model

Modelfile

```
FROM  llama-3-Korean-Bllossom-8B.gguf

SYSTEM """당신은 유용한 AI 어시스턴트입니다. 사용자의 질의에 대해 친절하고 정확하게 답변해야 합니다. You are a helpful AI assistant, you'll need to answer users' queries in a friendly and accurate manner. 모든 대답은 한국어(Korean)으로 대답해주세요."""


TEMPLATE """{{- if .System }}
<s>{{ .System }}</s>
{{- end }}
<s>Human:
{{ .Prompt }}</s>
<s>Assistant:
"""

PARAMETER temperature 0.6
PARAMETER num_predict 3000
PARAMETER num_ctx 4096
PARAMETER stop <s>
PARAMETER stop </s>
PARAMETER stop <|eot_id|>
```

실행

```bash
(huggingfacehub-py3.11) snoopy_kr@iMac llama.cpp % cd ..

(huggingfacehub-py3.11) snoopy_kr@iMac HuggingfaceHub % ollama create llama-korea -f Modelfile
```

획인

```bash
(huggingfacehub-py3.11) snoopy_kr@iMac HuggingfaceHub % ollama list
NAME                    ID              SIZE    MODIFIED    
llama-korea:latest      f8909476a010    16 GB   3 hours ago     
mistral:latest          2ae6f6dd7a3d    4.1 GB  2 weeks ago     
llama3:latest           365c0bd3c000    4.7 GB  2 weeks ago     
```

### Postman 작업

실행

URL : POST http://localhost:11434/api/generate

Headers : Content-Type application/json

Body : raw
  
{
  "model": "llama-korea",
  "prompt": "서울의 유명한 관광 코스를 만들어줄래",
  "stream": false
}

결과

```JSON
{
    "model": "llama-korea",
    "created_at": "2024-07-19T06:07:42.006458Z",
    "response": "안녕하세요! 서울을 방문하시는 동안 즐길 수 있는 다양한 관광 코스 중 몇 가지를 추천해드릴게요. 각 코스는 서울의 대표적인 명소와 함께 역사, 문화, 그리고 현대적 매력을 느낄 수 있도록 구성했습니다.\n\n1. **경복궁과 인사동 코스**\n   - 경복궁: 조선 시대의 주요 궁궐 중 하나로, 아름다운 건축물과 정원이 어우러져 있습니다.\n   - 인사동: 전통 문화와 현대 예술이 조화를 이루는 거리입니다. 다양한 전통 소품 가게와 갤러리, 그리고 맛집도 즐길 수 있습니다.\n\n2. **남산타워와 한강 코스**\n   - 남산타워: 서울의 상징적인 랜드마크로, 날씨를 감상할 수 있는 전망대가 있습니다.\n   - 한강: 걷기 또는 자전거 타기를 즐길 수 있으며, 여름에는 폭죽 축제나 야간 음악회 등 다양한 이벤트가 열립니다.\n\n3. **동대문과 홍대 코스**\n   - 동대문 디자인 플라자(DDP): 현대적인 건축물로 유명하며, 다양한 전시와 공연이 열리는 곳입니다.\n   - 홍대: 젊은이들이 즐겨 찾는 거리로, 독특한 카페와 레스토랑, 그리고 라이브 음악장소가 많습니다.\n\n4. **북촌 한옥마을과 창덕궁 코스**\n   - 북촌 한옥마을: 전통 한옥이 잘 보존된 마을로, 한국의 전통 건축과 생활상을 느낄 수 있습니다.\n   - 창덕궁: 조선 시대의 궁궐로, 정원과 함께 역사적 유물을 감상할 수 있습니다.\n\n이 외에도 서울에는 더 많은 매력 있는 장소가 많으니, 방문하시는 동안 즐거운 여행 되시길 바랍니다",
    "done": true,
    "done_reason": "stop",
    "context": [
        198,
        45147,
        29,
        65895,
        83628,
        34804,
        101003,
        27797,
        24486,
        15592,
        101139,
        30426,
        25941,
        95252,
        29726,
        80052,
        13,
        41820,
        110257,
        105689,
        21028,
        19954,
        112107,
        108280,
        104834,
        101360,
        127923,
        102893,
        111964,
        110513,
        109670,
        13,
        1472,
        527,
        264,
        11190,
        15592,
        18328,
        11,
        499,
        3358,
        1205,
        311,
        4320,
        3932,
        6,
        20126,
        304,
        264,
        11919,
        323,
        13687,
        11827,
        13,
        107036,
        126958,
        34804,
        104008,
        32179,
        17155,
        46295,
        8,
        43139,
        126958,
        34983,
        92769,
        4005,
        82,
        397,
        45147,
        29,
        35075,
        512,
        115978,
        21028,
        101003,
        80732,
        24486,
        93851,
        104176,
        103651,
        120155,
        118667,
        115087,
        54542,
        524,
        82,
        397,
        45147,
        29,
        72803,
        512,
        101193,
        124409,
        0,
        106010,
        18359,
        127900,
        111132,
        16969,
        113401,
        118598,
        106103,
        29833,
        65621,
        118696,
        93851,
        104176,
        103651,
        25941,
        72043,
        113156,
        109521,
        18918,
        109336,
        34983,
        30446,
        109883,
        58901,
        36811,
        13,
        106603,
        103651,
        119524,
        106010,
        21028,
        116865,
        103684,
        104167,
        44690,
        81673,
        106999,
        119229,
        11,
        115762,
        11,
        107536,
        122140,
        82068,
        102293,
        116688,
        122723,
        226,
        29833,
        123644,
        114702,
        116304,
        382,
        16,
        13,
        3146,
        66406,
        98934,
        121321,
        54780,
        59777,
        56154,
        58189,
        103651,
        25941,
        1035,
        256,
        482,
        44215,
        98934,
        121321,
        25,
        120244,
        45618,
        123094,
        120138,
        115542,
        166,
        114,
        238,
        72043,
        105454,
        17835,
        11,
        49508,
        64254,
        123366,
        103521,
        106734,
        101438,
        54780,
        37155,
        125422,
        101139,
        41381,
        61394,
        84377,
        103924,
        627,
        256,
        482,
        59777,
        56154,
        58189,
        25,
        57519,
        102233,
        115762,
        81673,
        122140,
        96717,
        102835,
        13094,
        66610,
        117216,
        120893,
        16969,
        101429,
        29102,
        80052,
        13,
        118696,
        57519,
        102233,
        101228,
        101696,
        36609,
        58901,
        81673,
        102405,
        127595,
        11,
        107536,
        119408,
        102201,
        49085,
        118598,
        106103,
        29833,
        103924,
        382,
        17,
        13,
        3146,
        101963,
        86157,
        101109,
        103430,
        81673,
        62398,
        102296,
        103651,
        25941,
        1035,
        256,
        482,
        102484,
        86157,
        101109,
        103430,
        25,
        106010,
        21028,
        59134,
        112932,
        103684,
        112451,
        250,
        30446,
        100711,
        82233,
        17835,
        11,
        105605,
        107497,
        18918,
        103185,
        57002,
        48936,
        29833,
        65621,
        57519,
        105115,
        67945,
        20565,
        103924,
        627,
        256,
        482,
        62398,
        102296,
        25,
        98272,
        115,
        21121,
        108520,
        65677,
        66965,
        93292,
        106149,
        106647,
        118598,
        106103,
        29833,
        117097,
        11,
        84618,
        64254,
        102772,
        115062,
        125643,
        110683,
        38187,
        61415,
        108332,
        63375,
        120282,
        62841,
        78102,
        118696,
        117266,
        20565,
        105069,
        106426,
        382,
        18,
        13,
        3146,
        58189,
        67945,
        52688,
        54780,
        109666,
        67945,
        103651,
        25941,
        1035,
        256,
        482,
        101604,
        67945,
        52688,
        126598,
        107375,
        51440,
        26799,
        7,
        4195,
        47,
        1680,
        122140,
        103684,
        103521,
        106734,
        101438,
        17835,
        101003,
        80732,
        108859,
        11,
        118696,
        57519,
        30426,
        81673,
        100994,
        101347,
        13094,
        105069,
        104374,
        111003,
        80052,
        627,
        256,
        482,
        109666,
        67945,
        25,
        19097,
        123143,
        13094,
        102823,
        118598,
        108381,
        107364,
        16969,
        101429,
        124146,
        11,
        107712,
        108159,
        24486,
        103236,
        104249,
        81673,
        102638,
        123642,
        102581,
        11,
        107536,
        114665,
        102914,
        120282,
        41953,
        44690,
        20565,
        104038,
        39331,
        382,
        19,
        13,
        3146,
        103825,
        112266,
        62398,
        115526,
        100711,
        18359,
        54780,
        107478,
        109814,
        121321,
        103651,
        25941,
        1035,
        256,
        482,
        108772,
        112266,
        62398,
        115526,
        100711,
        18359,
        25,
        57519,
        102233,
        62398,
        115526,
        13094,
        104670,
        64432,
        109074,
        53400,
        96677,
        18359,
        17835,
        11,
        104008,
        21028,
        57519,
        102233,
        103521,
        106734,
        54780,
        120376,
        114542,
        122723,
        226,
        29833,
        103924,
        627,
        256,
        482,
        107478,
        109814,
        121321,
        25,
        120244,
        45618,
        123094,
        115542,
        166,
        114,
        238,
        17835,
        11,
        37155,
        55421,
        54780,
        106999,
        119229,
        82068,
        101003,
        123402,
        103185,
        57002,
        48936,
        29833,
        103924,
        382,
        13094,
        103807,
        109018,
        106010,
        102772,
        102519,
        110187,
        102293,
        29854,
        65621,
        102027,
        44690,
        20565,
        104038,
        118081,
        11,
        127900,
        111132,
        16969,
        113401,
        118598,
        93292,
        94772,
        121528,
        98243,
        30426,
        106103,
        122419
    ],
    "total_duration": 275172921227,
    "load_duration": 8205175912,
    "prompt_eval_count": 93,
    "prompt_eval_duration": 6222256000,
    "eval_count": 422,
    "eval_duration": 260743871000
}
```